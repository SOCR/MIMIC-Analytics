---
title: "ESCAPE Data Pulling"
author: "<h3>SOCR MIMIC-III Team</h3>"
date: "`r format(Sys.time(), '%B %Y')`"
output:
  html_document:
  highlight: tango
number_sections: yes
theme: default
toc: yes
toc_depth: 2
toc_float:
  collapsed: no
smooth_scroll: yes
---
  
*Libraries Used*
```{r message=F, warning=F}
library('bigrquery')     # Query data from Google BigQuery
library('knitr')         # Make knited tables ("kables")
library('kableExtra')    # Extra kable formatting options
library('ggplot2')       # Plotting library
library('ggpubr')        # More options for ggplot
library("dplyr")

project = 'testingtesting123' # CHANGE THIS TO YOUR PROJECT ID
```

# Cohort Selection

## Criteria 1: Patients diagnosed with actue heart failure

To select patients with acute heart failure, we first constructed a cohort of all heart failure patients, denoted by the ICD9 code `4280`, then subtracted those that had an additional chronic heart failure diagnosis (codes `42822, 42823, 42832, 42833, 42842 & 42843`).

```{r message=F, warning=F}
sql <- "SELECT *
        FROM [physionet-data.mimiciii_clinical.diagnoses_icd]
        WHERE icd9_code IN ('4280')
        AND hadm_id NOT IN (
            SELECT hadm_id
            FROM [physionet-data.mimiciii_clinical.diagnoses_icd]
            WHERE icd9_code IN ('42822', '42823', '42832', '42833', '42842', '42843') 
            GROUP BY hadm_id
        )"

cohort <- query_exec(sql, project=project)
```

Based on this initial query, there are `r length(unique(cohort$HADM_ID))` unique encounters in our cohort representing `r length(unique(cohort$SUBJECT_ID))` individual subjects.

## Criteria 2: Subject survived to ICU discharge

As our target is predicting out-of-hospital mortality due to acute heart failure, we excude patients who expired in the hospital.

```{r message=F, warning=F}
# Retrieve PATIENTS table
patients.tbl <- query_exec(
  sprintf( "SELECT SUBJECT_ID, GENDER, DOB, DOD, DOD_HOSP, DOD_SSN 
            FROM [physionet-data.mimiciii_clinical.patients] 
            WHERE subject_id IN (%s)", 
          paste(cohort$SUBJECT_ID, collapse=", ")),
  project=project, max_pages = Inf)

# Merge with cohort object
cohort <- merge(cohort, patients.tbl, by='SUBJECT_ID')

# Remove subjects with an in-hospital date of death
cohort <- cohort[!is.na(cohort$DOD_HOSP), ]
```
After removing subjects who did not survive to ICU discharge, we are left with `r length(unique(cohort$HADM_ID))` unique encounters representing `r length(unique(cohort$SUBJECT_ID))` individual subjects.

## Criteria 3: Length of stay between 24-hours and 45 days

```{r message=F, warning=F}
# Get admissions table object
admissions.tbl <- query_exec(
  sprintf( "SELECT *
            FROM [physionet-data.mimiciii_clinical.admissions] 
            WHERE hadm_id IN (%s)", 
          paste(cohort$HADM_ID, collapse=", ")),
  project=project, max_pages = Inf)

# Calculate length of stay
admissions.tbl$LOS <- difftime(admissions.tbl$DISCHTIME, admissions.tbl$ADMITTIME, unit='days')

# Merge with cohort object
cohort <- merge(cohort, admissions.tbl[, c('SUBJECT_ID', 'HADM_ID', 'DISCHTIME', 'ADMITTIME', 'LOS')], by=c('SUBJECT_ID', 'HADM_ID'))

# Remove encounters where LOS falls outside bounds
cohort <- cohort[cohort$LOS > 1 & cohort$LOS <= 45, ]
```

After removing subjects who did not survive to ICU discharge, we are left with `r length(unique(cohort$HADM_ID))` unique encounters representing `r length(unique(cohort$SUBJECT_ID))` individual subjects.

## Criteria 4: Patients 18 years or older 

To select patients 18 or older, first we join the patients table and the admissions table to get the admissions ID and the date of birth. DOB is the date of birth of the given patient. All dates in the database have been shifted to protect patient confidentiality. Dates are internally consistent for the same patient, but randomly distributed in the future. Dates of birth which occur in the present time are not true dates of birth. Furthermore, dates of birth which occur before the year 1900 occur if the patient is older than 89. In these cases, the patient's age at their first admission has been fixed to 300 to obscure their age and comply with HIPAA. The shift process was as follows: the patient's age at their first admission was determined. The date of birth was then set to exactly 300 years before their first admission. Therefore, we also extract the first admission time so we can calculate the age of the patient at the time of first admission. Finally, we exclude those younger than 18 at the time of first admission.

```{r message=F, warning=F}
sql <- sprintf(
       "SELECT *
        FROM [physionet-data.mimiciii_clinical.admissions] AS admissions
        JOIN [physionet-data.mimiciii_clinical.patients] AS patients
        ON admissions.subject_id = patients.subject_id
        WHERE admissions.hadm_id IN (%s)",
        paste(cohort$HADM_ID, collapse = ", "))

age.tbl <- query_exec(sql, project=project)
age.tbl$age <- difftime(age.tbl$admissions_ADMITTIME, age.tbl$patients_DOB, units='days')

age.tbl <- data.frame(age.tbl[, c('admissions_HADM_ID', 'age')])
colnames(age.tbl) <- c('HADM_ID', 'AGE')
cohort <- merge(cohort, age.tbl, by="HADM_ID")
cohort$AGE <- as.numeric(cohort$AGE) / 365

cohort <- cohort[cohort$AGE < 90 & cohort$AGE >= 18, ]
```

The final cohort consists of `r nrow(cohort)` encounters.

# Data extraction

```{r message=F, warning=F}
pull.last.event <- function(hadm_id, itemcodes, return.fields, table, project, max_pages=Inf) {
  sql <- sprintf("
                 SELECT *
                 FROM [physionet-data.mimiciii_clinical.%s] AS table1
                 INNER JOIN (
                   SELECT hadm_id, MAX(charttime), MAX(row_id)
                   FROM [physionet-data.mimiciii_clinical.%s]
                   WHERE itemid IN (%s)
                   AND hadm_id IN (%s)
                   GROUP BY hadm_id
                 ) AS table2
                 ON table1.row_id = table2.f1_",
                 table, table, 
                 paste(itemcodes, collapse=", "),
                 paste(hadm_id, collapse=", ")
  )
  
  data <- query_exec(sql, project=project, max_pages=max_pages)
  colnames(data) <- gsub('table[0-9]_', '', colnames(data))
  return(data[ , return.fields])
}

get_itemids = function(label) {
  label = tolower(label)
  sql = paste0('SELECT * FROM [physionet-data.mimiciii_clinical.d_items] WHERE LOWER(label) LIKE "%',label, '%"')
  data = query_exec(sql, project=project)
  itemids = data$ITEMID
  
  sql = paste0('SELECT * FROM [physionet-data.mimiciii_clinical.d_labitems] WHERE LOWER(label) LIKE "%',label, '%"')
  data = query_exec(sql, project=project)
  itemids = c(itemids, data$ITEMID)
  
  return(itemids)
}

get_values_from_ids = function(itemids, hadm_id=c(), table) {
  if (length(itemids) == 0) {
    return(list())
  }
  sql = sprintf('SELECT * FROM [physionet-data.mimiciii_clinical.%s] WHERE itemid IN (%s) AND hadm_id IN (%s)', 
                table,
                paste0(itemids, collapse = ", "), 
                paste(hadm_id, collapse=", "))
  data = query_exec(sql, project=project, max_pages=1)
  print(kable(data) %>% kable_styling(bootstrap_options = 'striped'))

  data
}


return.fields <- c('SUBJECT_ID', 'HADM_ID', 'ITEMID', 'CHARTTIME', 'VALUENUM', 'VALUEUOM')

get_values = function(label, table='chartevents') {
  return(get_values_from_ids(get_itemids(label), cohort$HADM_ID, table))
}
```

## BNP

```{r}
get_values("bnp", 'labevents')
```

## Diuretics

```{r}
diuretic = get_values("lasix", "inputevents_mv")
```

## Beta-blockers

```{r}
blocker = get_values("lol", "inputevents_mv")
```

## CPR/Mechanical ventilation

```{r}
cpr_codes = c(9960, 9390, 967, 9670, 9671, 9672)
sql = sprintf('SELECT * FROM [physionet-data.mimiciii_clinical.procedures_icd] 
              WHERE icd9_code IN (%s) AND hadm_id IN (%s)', 
              paste0(cpr_codes, collapse = ", "), 
              paste0(cohort$HADM_ID, collapse=", "))
cpr = query_exec(sql, project=project, max_pages=1)
print(kable(data) %>% kable_styling(bootstrap_options = 'striped'))
```
